BINARY       = bin/price-fetcher
PROTO_DIR    = proto
PROTO_FILE   = $(PROTO_DIR)/service.proto
LISTEN_ADDR  = :3000

.PHONY: all build run clean proto docker-build docker-run test lint

all: build

## Build the binary
build:
	@mkdir -p bin
	CGO_ENABLED=0 go build -o $(BINARY) .

## Build and run the server
run: build
	./$(BINARY) -listenaddr=$(LISTEN_ADDR)

## Run without rebuilding (useful during development)
dev:
	go run . -listenaddr=$(LISTEN_ADDR)

## Run tests
test:
	go test ./... -v -race

## Lint the code (requires golangci-lint)
lint:
	golangci-lint run ./...

## Generate Go code from proto
proto:
	protoc --go_out=. --go_opt=paths=source_relative \
		--go-grpc_out=. --go-grpc_opt=paths=source_relative \
		$(PROTO_FILE)

## Build Docker image
docker-build:
	docker build -t price-fetcher:latest .

## Run Docker container
docker-run:
	docker run --rm -p 3000:3000 price-fetcher:latest

## Remove build artifacts
clean:
	rm -rf bin/
